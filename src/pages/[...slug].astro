---
import PostLayout from '../layouts/PostLayout.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllPosts, getAllPages, getSlugFromUri } from '../lib/wordpress';
import { optimizeContentLinksAndImages, getResponsiveImage, updateWordPressImageUrls, cleanCanonicalUrl, resetOptimizationStats, getOptimizationStats, generatePageSchema } from '../lib/utils';

export async function getStaticPaths() {
  console.log('\nðŸ”¨ Building all content...\n');
  
  // Initialize optimization statistics
  resetOptimizationStats();
  
  const [posts, pages] = await Promise.all([
    getAllPosts(),
    getAllPages()
  ]);
  
  // Filter out the homepage from pages (we handle it separately)
  const pagesWithoutHome = pages.filter(page => page.slug !== '22416-2');
  
  const allContent = [...posts, ...pagesWithoutHome];
  
  console.log(`\nðŸ“„ Generating ${allContent.length} static pages\n`);
  
  // Sort posts by date for navigation (newest first)
  const sortedPosts = posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
  
  const staticPaths = allContent.map(item => {
    const slug = getSlugFromUri(item.uri);
    const isPost = posts.some(p => p.id === item.id);
    
    // Calculate next/previous posts for blog posts only
    let nextPost = null;
    let previousPost = null;
    
    if (isPost) {
      const currentIndex = sortedPosts.findIndex(p => p.id === item.id);
      if (currentIndex > 0) {
        nextPost = {
          title: sortedPosts[currentIndex - 1].title,
          uri: sortedPosts[currentIndex - 1].uri
        };
      }
      if (currentIndex < sortedPosts.length - 1) {
        previousPost = {
          title: sortedPosts[currentIndex + 1].title,
          uri: sortedPosts[currentIndex + 1].uri
        };
      }
    }
    
    console.log(`  â†’ /${slug} (${isPost ? 'post' : 'page'})`);
    
    return {
      params: { slug: slug || undefined },
      props: { 
        content: item, 
        isPost,
        nextPost,
        previousPost
      }
    };
  });
  
  // Log optimization stats after processing all content
  setTimeout(() => {
    const stats = getOptimizationStats();
    stats.log();
  }, 100);
  
  return staticPaths;
}

const { content, isPost, nextPost, previousPost } = Astro.props;

// Generate enhanced schema for pages
const pageUrl = `https://dragosroua.com${content.uri}`;
const enhancedSchema = content.seo?.schema?.raw || generatePageSchema(content, pageUrl);

// Use PostLayout for posts (includes iOS ad + Substack)
// Use BaseLayout for pages (cleaner, for product tables)
---

{isPost ? (
  <PostLayout post={content} nextPost={nextPost} previousPost={previousPost} />
) : (
  <BaseLayout 
    title={content.seo?.title || content.title}
    description={content.seo?.metaDesc || ''}
    ogImage={updateWordPressImageUrls(content.seo?.opengraphImage?.sourceUrl || content.featuredImage?.node?.sourceUrl) || 'https://dragosroua.com/images/default-featured-1200-630.png'}
    canonical={cleanCanonicalUrl(content.seo?.canonical) || pageUrl}
    schema={enhancedSchema}
  >
    <article class="page">
      <h1 set:html={content.title} />
      
      {content.featuredImage?.node?.sourceUrl && (() => {
        const heroImage = getResponsiveImage(content.featuredImage, content.title);
        return (
          <img 
            src={heroImage.src}
            srcset={heroImage.srcset}
            sizes={heroImage.sizes}
            alt={heroImage.alt}
            class="hero-image"
            width={heroImage.width}
            height={heroImage.height}
            loading="eager"
            decoding="async"
          />
        );
      })()}
      
      <div class="wp-content" set:html={optimizeContentLinksAndImages(content.content, content.title)} />
    </article>
  </BaseLayout>
)}