---
import BaseLayout from './BaseLayout.astro';
import SubstackSubscribe from '../components/SubstackSubscribe.astro';
import EmailSignup from '../components/EmailSignup.astro';
import ShareButtons from '../components/ShareButtons.astro';
import SeriesNav from '../components/SeriesNav.astro';
import { optimizeContentLinksAndImages, getResponsiveImage, updateWordPressImageUrls, cleanCanonicalUrl, cleanSchemaUrls, getSeriesInfo } from '../lib/utils';

interface Props {
  post: any;
  nextPost?: { title: string; uri: string } | null;
  previousPost?: { title: string; uri: string } | null;
}

const { post, nextPost, previousPost } = Astro.props;

const seo = post.seo || {};
const title = seo.title || post.title;
const description = seo.metaDesc || post.content?.replace(/<[^>]*>/g, '').substring(0, 160) || '';
const ogImage = updateWordPressImageUrls(seo.opengraphImage?.sourceUrl || post.featuredImage?.node?.sourceUrl) || '/images/default-featured-1200-630.png';
const canonical = cleanCanonicalUrl(seo.canonical) || `https://dragosroua.com${post.uri}`;
const schema = seo.schema?.raw ? cleanSchemaUrls(seo.schema.raw) : null;

const processedContent = optimizeContentLinksAndImages(post.content, post.title);
const heroImage = getResponsiveImage(post.featuredImage, post.title);

// Get categories and tags
const categories = post.categories?.nodes || [];
const tags = post.tags?.nodes || [];

// Check if this is part of any series
const postSlug = post.uri.replace(/^\/|\/$/g, ''); // Remove leading/trailing slashes
const seriesInfo = getSeriesInfo(postSlug);
---

<BaseLayout 
  title={title}
  description={description}
  ogImage={ogImage}
  canonical={canonical}
  schema={schema}
>
  <article class="post">
    <h1 set:html={post.title} />
    
    <div class="post-meta">
      <time datetime={post.date}>
        {new Date(post.date).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </time>
    </div>

    {/* Series Navigation - Top */}
    {seriesInfo && (seriesInfo.navigationPlacement === "top" || seriesInfo.navigationPlacement === "both") && (
      <SeriesNav 
        seriesTitle={seriesInfo.seriesTitle}
        hubUrl={seriesInfo.hubUrl}
        current={seriesInfo.current}
        next={seriesInfo.next}
        previous={seriesInfo.previous}
        total={seriesInfo.total}
        series={seriesInfo.series}
      />
    )}
    
    {post.featuredImage?.node?.sourceUrl && (
      <img 
        src={heroImage.src}
        srcset={heroImage.srcset}
        sizes={heroImage.sizes}
        alt={heroImage.alt}
        class="hero-image"
        width={heroImage.width}
        height={heroImage.height}
        loading="eager"
        decoding="async"
      />
    )}
    
    <!-- iOS App Ad -->
    <div class="app-promo-box">
      <div class="app-promo-grid">
        <div class="app-image-col">
          <img 
            src="/images/blog-box-promo.webp" 
            alt="addTaskManager App Screenshot"
            class="app-screenshot"
          />
        </div>
        
        <div class="app-text-col">
          <h2 class="app-title">ðŸ˜Œ addTaskManager: Take control of your life</h2>
          <p class="app-desc">Take control of your life with powerful Assess-Decide-Do framework</p>
          <p class="app-desc">iPhone, iPad and iMac real time data syncing</p>
          <p class="app-desc-last">Available in English, í•œêµ­ì–´, æ—¥æœ¬èªž, ä¸­æ–‡, FranÃ§ais and Tiáº¿ng Viá»‡t</p>
        </div>
      </div>
      
      <div class="app-button-row">
        <a 
          href="https://itunes.apple.com/app/apple-store/id1492487688?mt=8" 
          class="app-store-button" 
          target="_blank" 
          rel="noopener noreferrer"
        >
          <svg class="apple-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
          Download on App Store
        </a>
      </div>
    </div>
    
    <div class="wp-content" set:html={processedContent} />
    
    {/* Series Navigation - Bottom */}
    {seriesInfo && (seriesInfo.navigationPlacement === "bottom" || seriesInfo.navigationPlacement === "both") && (
      <SeriesNav 
        seriesTitle={seriesInfo.seriesTitle}
        hubUrl={seriesInfo.hubUrl}
        current={seriesInfo.current}
        next={seriesInfo.next}
        previous={seriesInfo.previous}
        total={seriesInfo.total}
        series={seriesInfo.series}
      />
    )}
    
    <EmailSignup />
    
    <!-- Share buttons -->
    <ShareButtons 
      url={`https://dragosroua.com${post.uri}`}
      title={post.title}
      description={description}
    />
    
    <!-- Post Taxonomy Footer -->
    <div class="post-taxonomy">
      {/* Categories - Always show if present */}
      {categories.length > 0 && (
        <div class="taxonomy-section">
          <span class="taxonomy-label">Published in:</span>
          {categories.slice(0, 5).map((category, index) => (
            <Fragment>
              <a 
                href={`/category/${category.slug}/`} 
                class="taxonomy-link"
                aria-label={`View all posts in ${category.name} category`}
              >
                {category.name}
              </a>
              {index < Math.min(4, categories.length - 1) && <span>, </span>}
            </Fragment>
          ))}
          {categories.length > 5 && (
            <span class="taxonomy-more"> and {categories.length - 5} more</span>
          )}
        </div>
      )}
      
      {/* Tags - Only show if post has tags */}
      {tags.length > 0 && (
        <div class="taxonomy-section">
          <span class="taxonomy-label">Tagged as:</span>
          {tags.slice(0, 8).map((tag, index) => (
            <Fragment>
              <a 
                href={`/tag/${tag.slug}/`} 
                class="taxonomy-link taxonomy-tag"
                aria-label={`View all posts tagged with ${tag.name}`}
                title={`Browse posts about ${tag.name}`}
              >
                {tag.name.length <= 3 ? tag.name + " topics" : tag.name}
              </a>
              {index < Math.min(7, tags.length - 1) && <span>, </span>}
            </Fragment>
          ))}
          {tags.length > 8 && (
            <span class="taxonomy-more"> and {tags.length - 8} more</span>
          )}
        </div>
      )}
    </div>
    
    <!-- Post Navigation -->
    {(nextPost || previousPost) && (
      <div class="post-navigation">
        {previousPost && (
          <a href={previousPost.uri} class="nav-card nav-previous">
            <span class="nav-direction">Previous</span>
            <h3 class="nav-title" set:html={previousPost.title} />
          </a>
        )}
        
        {nextPost && (
          <a href={nextPost.uri} class="nav-card nav-next">
            <span class="nav-direction">Next</span>
            <h3 class="nav-title" set:html={nextPost.title} />
          </a>
        )}
      </div>
    )}
  </article>
</BaseLayout>

<style>
  .post-meta {
    color: #595959; /* WCAG AA compliant - was #666 */
    margin-bottom: 2rem;
    font-size: 0.9rem;
  }
  
  .hero-image {
    margin: 2rem auto;
    display: block;
    max-width: 800px;
  }
  
  /* iOS App Ad Styles */
  .app-promo-box {
    display: block;
    width: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 25px 0;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
  }
  
  .app-promo-grid {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .app-image-col {
    display: flex;
    align-items: flex-start;
  }
  
  .app-screenshot {
    width: 120px;
    height: 180px;
    object-fit: contain;
    border-radius: 18px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .app-text-col {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  
  .app-title {
    color: #ffffff;
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 8px 0;
    line-height: 1.3;
  }
  
  .app-desc {
    color: rgba(255, 255, 255, 0.95);
    font-size: 14px;
    margin: 0 0 6px 0;
    line-height: 1.5;
  }

  .app-desc-last {
    color: rgba(255, 255, 255, 0.95);
    font-size: 14px;
    margin: 0 0 15px 0;
    line-height: 1.5;
  }
  
  .app-button-row {
    display: flex;
    justify-content: center;
    padding-top: 8px;
  }
  
  .app-store-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #000000;
    color: #ffffff;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    border: none;
    cursor: pointer;
  }
  
  .app-store-button:hover {
    background: #1a1a1a;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    color: #ffffff;
  }
  
  .apple-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }
  
  /* Post Taxonomy Footer */
  .post-taxonomy {
    margin: 3rem 0 2rem;
    padding: 1.5rem 0 0;
    border-top: 2px solid #e5e5e5;
  }
  
  .taxonomy-section {
    margin-bottom: 1rem;
    line-height: 1.8;
    font-size: 0.95rem;
  }
  
  .taxonomy-section:last-child {
    margin-bottom: 0;
  }
  
  .taxonomy-label {
    color: #595959; /* WCAG AA compliant - was #666 */
    font-weight: 500;
    margin-right: 0.5rem;
  }
  
  .taxonomy-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .taxonomy-link:hover {
    color: #5568d3;
    text-decoration: underline;
  }
  
  .taxonomy-tag {
    font-size: 0.9rem;
  }
  
  .taxonomy-more {
    color: #767676; /* WCAG AA compliant - was #999 */
    font-style: italic;
    font-size: 0.9rem;
  }
  
  /* Post Navigation */
  .post-navigation {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin: 3rem 0 2rem;
  }
  
  .nav-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    display: block;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  
  .nav-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-color: #cbd5e0;
  }
  
  .nav-direction {
    color: #667eea;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    display: block;
  }
  
  .nav-title {
    color: #2d3748;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1.4;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .nav-card:hover .nav-title {
    color: #1a202c;
  }
  
  /* Single navigation item takes full width */
  .post-navigation:has(.nav-card:only-child) .nav-card {
    grid-column: 1 / -1;
    max-width: 50%;
  }
  
  .nav-next {
    text-align: right;
  }
  
  .nav-previous {
    text-align: left;
  }
  
  /* Mobile responsive */
  @media (max-width: 600px) {
    .app-promo-box {
      padding: 15px;
    }
    
    .app-promo-grid {
      text-align: center;
    }
    
    .app-screenshot {
      margin: 0 auto;
    }
    
    .app-text-col {
      text-align: center;
    }
    
    .app-title {
      font-size: 16px;
    }
    
    .app-store-button {
      font-size: 13px;
    }
    
    .taxonomy-section {
      font-size: 0.9rem;
    }
    
    /* Navigation mobile styles */
    .post-navigation {
      grid-template-columns: 1fr;
      gap: 1rem;
      margin: 2rem 0 1.5rem;
    }
    
    .nav-card {
      padding: 1.25rem;
      text-align: left !important;
    }
    
    .nav-title {
      font-size: 1.125rem;
    }
    
    .post-navigation:has(.nav-card:only-child) .nav-card {
      max-width: 100%;
    }
  }
</style>